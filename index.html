<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>100 Level: Detektif Kota</title>
<meta name="description" content="Game detektif 100 level dengan mode Hard, papan skor, ekspor/impor progres, tema terang/gelap, dan pemilih avatar dari GitHub."/>
<style>
:root{--bg:#0b1220;--card:#101a2b;--muted:#98a2b3;--text:#e6edf3;--accent:#73d7ff;--ok:#22c55e;--bad:#ff6b6b;--ring:#2b3a55}
*{box-sizing:border-box}body{margin:0;font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;color:var(--text);background:linear-gradient(120deg,#0b1220 0%,#111a2c 100%);min-height:100vh;display:flex;flex-direction:column}
header{position:sticky;top:0;z-index:10;backdrop-filter:blur(8px);background:rgba(16,26,43,.7);border-bottom:1px solid #22304d;padding:.8rem 1rem;display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}
header h1{font-size:1.05rem;margin:0}.pill{padding:.35rem .7rem;background:#0e172a;border:1px solid #1f2c48;border-radius:999px;color:#a8b3c6}
main{width:100%;max-width:1200px;margin:16px auto;padding:0 14px;flex:1;display:grid;gap:16px}
.two{display:grid;gap:14px;grid-template-columns:1.4fr .9fr}@media(max-width:980px){.two{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid #1f2c48;border-radius:18px;box-shadow:0 10px 35px rgba(0,0,0,.25)}.card .body{padding:16px 18px}
.title{font-weight:700;font-size:1.05rem}.muted{color:var(--muted)}.row{display:flex;flex-wrap:wrap;gap:10px}
.badge{background:#0f1a2d;border:1px solid #253454;color:#b8c2d6;padding:.3rem .55rem;border-radius:8px;font-size:.86rem}
.story{white-space:pre-wrap}.suspects{display:grid;gap:12px;grid-template-columns:repeat(3,1fr)}@media(max-width:860px){.suspects{grid-template-columns:1fr}}
.sus{position:relative;border-radius:16px;overflow:hidden;border:1px solid #22314e;background:#0f182a}
.sus header{all:unset;display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid #1d2a45;background:#0e1627}
.ava{font-size:28px;width:42px;height:42px;display:grid;place-items:center;background:#0b1324;border:1px solid #1f2b46;border-radius:12px}
.sus .body{padding:12px 14px}.sus .meta{display:flex;gap:8px;flex-wrap:wrap}.sus label{display:block;cursor:pointer}.sus input{transform:scale(1.15);accent-color:#58c1ff}
.foot{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-top:1px solid #1d2a45;background:#0e1627}
button{appearance:none;border:1px solid #2b3f63;background:#0e172a;color:#e6edf3;padding:.7rem 1rem;border-radius:12px;cursor:pointer;font-weight:600;transition:.2s transform,.2s background}
button.primary{background:linear-gradient(180deg,#0d9cf3,#0676be);border-color:#0c7dd3}button.success{background:linear-gradient(180deg,#22c55e,#16a34a);border-color:#16a34a}button:active{transform:translateY(1px)}
.center{display:grid;place-items:center}.progress{height:10px;border-radius:10px;background:#0d1527;border:1px solid #1f2b48;overflow:hidden}.progress>i{display:block;height:100%;background:linear-gradient(90deg,#4cc9f0,#22c55e);width:0%}
.toast{padding:.65rem .85rem;border:1px solid #263758;background:#0e192c;border-radius:10px}.ok{color:#a6f4c5}.bad{color:#ffb3b3}.small{font-size:.88rem}
footer{padding:18px 14px;text-align:center;color:#93a0b3}.tbl{width:100%;border-collapse:separate;border-spacing:0 8px}
.tbl th,.tbl td{padding:8px 10px}.tbl tr{background:#0e1627;border:1px solid #1f2b46}.tbl tr td:first-child,.tbl tr th:first-child{border-radius:10px 0 0 10px}.tbl tr td:last-child,.tbl tr th:last-child{border-radius:0 10px 10px 0}
.hidden{display:none}

/* ===== Avatar Modal ===== */
#avatarBtn{display:flex;align-items:center;gap:8px}
#avatarImg{width:28px;height:28px;border-radius:50%;border:1px solid #2b3f63;object-fit:cover;background:#0e172a}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px}
.modal .panel{max-width:900px;width:100%;background:var(--card);border:1px solid #1f2c48;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.4)}
.panel header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #1f2c48;background:#0e1627}
.grid{display:grid;gap:12px;padding:14px;grid-template-columns:repeat(auto-fill,minmax(110px,1fr))}
.item{border:1px solid #22314e;border-radius:12px;background:#0f182a;cursor:pointer;overflow:hidden}
.item:hover{box-shadow:0 6px 16px rgba(0,0,0,.2)}
.item img{width:100%;height:90px;object-fit:contain;background:#0b1324}
.item .cap{padding:8px 10px;font-size:.85rem;color:#bcd}
</style>
</head>
<body>
<header>
  <h1>üïµÔ∏è‚Äç‚ôÇÔ∏è 100 Level: Detektif Kota</h1>
  <span id="levelBadge" class="pill">Level 1 / 100</span>
  <span id="scoreBadge" class="pill">Skor 0</span>
  <span id="modeBadge" class="pill">Mode: Normal</span>
  <div class="pill" id="detBadge">Detektif: ‚Äî</div>
  <div class="pill" id="lokBadge">Lokasi: ‚Äî</div>
  <div style="flex:1"></div>

  <!-- Tombol Avatar -->
  <button id="avatarBtn" class="pill" title="Pilih Avatar">
    <img id="avatarImg" alt="">
    <span>Pilih Avatar</span>
  </button>

  <button id="btnTema" class="pill">Tema: Gelap</button>
  <button id="btnMode" class="pill">Switch Hard</button>
  <button id="btnReset" class="pill">Reset</button>
  <button id="btnExport" class="pill">Ekspor</button>
  <label class="pill" style="cursor:pointer">
    Impor <input id="fileImport" type="file" accept="application/json" class="hidden">
  </label>
</header>

<main class="two">
  <section class="card">
    <div class="body" style="display:grid;gap:16px">
      <div class="title">üìÇ Kasus</div>
      <div id="story" class="story"></div>

      <div class="row">
        <span class="badge" id="badgeLok"></span>
        <span class="badge" id="badgeWaktu"></span>
        <span class="badge" id="badgeJenis"></span>
        <span class="badge" id="badgePartner"></span>
      </div>

      <div class="title">üë• Tersangka</div>
      <div id="suspects" class="suspects"></div>

      <div class="row">
        <button id="btnKunci" class="primary">Kunci Jawaban</button>
        <button id="btnHint">Beri Petunjuk</button>
        <button id="btnLewati">Lewati Level</button>
      </div>

      <div id="result" class="toast small hidden"></div>

      <div class="row" style="align-items:center;gap:12px">
        <div style="min-width:80px">Kemajuan</div>
        <div class="progress" style="flex:1"><i id="prog"></i></div>
        <button id="btnNext" class="success hidden">Lanjut ‚ûú</button>
      </div>
    </div>
  </section>

  <aside class="card">
    <div class="body" style="display:grid;gap:16px">
      <div class="title">üß≠ Navigasi</div>
      <div class="row">
        <input id="goto" type="number" min="1" max="100" value="1" class="pill" style="width:120px">
        <button id="btnGoto">Ke Level</button>
      </div>

      <div class="title">üéÆ Profil</div>
      <div class="row">
        <input id="nick" class="pill" placeholder="Nickname" style="flex:1;min-width:160px">
        <button id="btnSaveNick">Simpan</button>
      </div>
      <div class="muted small">Nama & avatar dipakai saat kirim skor.</div>

      <div class="title">üèÜ Papan Skor</div>
      <div class="small muted">Terakhir 50 skor tertinggi.</div>
      <table class="tbl" id="board"><thead><tr><th>#</th><th>Nama</th><th>Skor</th><th>Mode</th><th>Waktu</th></tr></thead><tbody></tbody></table>
      <div class="row">
        <button id="btnSubmitScore" class="success">Kirim Skor</button>
        <button id="btnRefreshBoard">Refresh</button>
      </div>

      <div class="title">‚ÑπÔ∏è Aturan</div>
      <ul class="small muted" style="margin:0 0 2px 18px;padding:0">
        <li>Normal: 3 tersangka, 3 petunjuk. Benar +10, salah ‚àí3, hint ‚àí1.</li>
        <li>Hard: 5 tersangka, 1‚Äì2 petunjuk. Benar +12, salah ‚àí5, hint ‚àí2.</li>
      </ul>
    </div>
  </aside>
</main>

<footer>¬© 2025 ‚Äî Detektif Kota. Semua fiksi.</footer>

<!-- ===== Avatar Modal ===== -->
<div id="avatarModal" class="modal" role="dialog" aria-modal="true">
  <div class="panel">
    <header>
      <b>üé≠ Pilih Avatar</b>
      <button id="avatarClose" class="pill">Tutup</button>
    </header>
    <div id="avatarGrid" class="grid"></div>
  </div>
</div>

<script>
/* ================== CONFIG AVATAR (ubah ke repo kamu) ================== */
const AVATAR_CFG = {
  OWNER:  "masihlapars-hub",    // ‚Üê ganti
  REPO:   "tebakz",             // ‚Üê ganti
  BRANCH: "main",
  PATH:   "tebakz/static/avatars" // folder di repo tempat kamu upload gambar
};

/* ================== Papan Skor (opsional publik) ==================
   Kalau mau publik, isi URL endpoint (CORS JSON):
   GET -> [{name,score,mode,avatar,ts}], POST -> {name,score,mode,avatar,ts}
*/
const SCOREBOARD_ENDPOINT = ""; // contoh: "https://script.google.com/macros/s/AKfycb.../exec"

/* ================== Util & PRNG ================== */
class PRNG{constructor(seed){this.s=seed>>>0} next(){this.s=(1664525*this.s+1013904223)>>>0;return this.s/2**32} pick(a){return a[Math.floor(this.next()*a.length)]}}
const $=q=>document.querySelector(q), $$=q=>document.querySelectorAll(q);
function esc(s){return (s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}
function timeago(ts){const s=Math.floor((Date.now()-ts)/1000);if(s<60)return s+" dtk lalu";const m=Math.floor(s/60);if(m<60)return m+" mnt lalu";const h=Math.floor(m/60);if(h<24)return h+" jam lalu";const d=Math.floor(h/24);return d+" hari lalu"}

/* ================== Data Pools ================== */
const TOTAL=100;
const NAMA=["Aji","Bima","Cika","Dina","Eko","Fira","Gilang","Hana","Indra","Joko","Kyla","Lia","Miko","Nara","Ojan","Putri","Qila","Rino","Salsa","Tegar","Uti","Vino","Wulan","Xena","Yuda","Zara","Aksa","Bela","Ceko","Dito","Eli","Fadil","Gita","Heri","Ira","Jani","Kori","Lana","Mora","Niko","Ovi","Puti","Qori","Raka","Seno","Tia","Ucup","Vira","Wibi","Yani","Kamal","Bahar","Celine","Dewi","Evan","Farah","Ghani","Hesti","Ilham","Jihan","Kevin","Laras","Mahen","Nabila","Omar","Pras","Qiana","Rizky","Sasha","Tito","Umar","Vallen","Wisnu","Yessi","Zidan"];
const EMOJI=["ü¶ä","üêº","üê±","üê∂","üêª","ü¶Å","üêµ","ü¶â","ü¶Ñ","üê∏","üßë","üë©","üë®","üë©‚Äçü¶∞","üßî","üë±‚Äç‚ôÄÔ∏è","üë©‚Äçü¶±","üë©‚Äçü¶≥","üßë‚Äçüé§","üßë‚Äçüíª","üßë‚Äçüç≥","üßë‚Äçüîß","üßë‚Äçüé®","üßë‚Äçüè´","üßë‚Äçüî¨"];
const KOTA=["Jakarta","Bandung","Surabaya","Yogyakarta","Semarang","Malang","Medan","Makassar","Denpasar","Bogor","Tangerang","Depok","Bekasi","Solo","Padang","Palembang","Banjarmasin","Balikpapan","Samarinda","Pontianak","Batam","Pekanbaru","Manado","Kupang","Jayapura","Mataram","Ambon","Ternate","Banda Aceh","Cirebon","Tasikmalaya","Purwokerto","Kediri","Madiun","Jember","Lumajang","Magelang","Salatiga","Cilacap","Serang","Cilegon","Sukabumi","Garut","Karawang","Subang","Indramayu","Klaten","Karanganyar","Gianyar","Tabanan"];
const TEMPAT=["galeri seni","perpustakaan kota","stasiun kereta","pasar malam","gedung konser","museum sejarah","taman kota","kafe 24 jam","hotel tua","gudang pelabuhan","kantor startup","laboratorium","studio musik","bioskop","rumah lelang","pameran teknologi","toko perhiasan","ruang server","ruang arsip","arena e-sport","terminal bus","alun-alun","rumah susun","terminal feri","lorong bawah tanah","rumah sakit","kampus teknik","pabrik tekstil","rumah dinas","hotel butik","lapangan futsal","pantai kota","bukit radio","terminal kargo","pusat data","balai kota","pasar antik","toko komik","studio foto","toko bunga","taman bermain","bandara lama","dermaga timur","gudang logistik","rumah kaca","toko jam","rumah bordir","kios koran","peron 3","galeri fotografi"];
const JENIS=["pencurian artefak","peretasan server","pemalsuan dokumen","sabotase listrik","penculikan kucing seleb","perampokan mini","pencurian lukisan","kebocoran rahasia produk","penggelapan kas","pemerasan anonim","pencurian berlian","pembobolan brankas","perusakan karya seni","penipuan lelang","pencurian prototipe"];
const JAM=["dini hari","pagi","siang","sore","malam","tengah malam"];
const MITRA=[["Riko","analisis sidik jari kilat"],["Maya","ahli membaca gerak tubuh"],["Seno","spesialis CCTV"],["Vira","pakar jejak digital"],["Bara","intel jalanan"]];
const WARNA=["merah","biru","hijau","hitam","putih","kuning","ungu","cokelat","abu-abu","oranye"];
const BARANG=["ransel","payung","kotak makan","helm","sarung tangan","obeng","kamera","buku sketsa","USB","jaket hujan","topi","botol minum","tongkat selfie","masker","sepatu lari"];
const TANGAN=["kanan","kidal"];

/* ================== State ================== */
const store={get(){try{return JSON.parse(localStorage.getItem("detektif100")||"{}")}catch{return {}}},set(v){localStorage.setItem("detektif100",JSON.stringify(v))}};
let state=Object.assign({level:1,score:0,unlocked:1,mode:"normal",nick:"",theme:"dark",avatar:""},store.get());

/* ================== Meta Level Unik ================== */
const metaLevels = (() => {
  const rng=new PRNG(987654);
  const names=[...NAMA]; const usedNames=new Set(); const usedPlace=new Set();
  const meta={};
  for(let lv=1; lv<=TOTAL; lv++){
    let det; for(let tries=0; tries<500; tries++){det=rng.pick(names); if(!usedNames.has(det)){usedNames.add(det);break}}
    let kota, tempat, key; for(let tries=0; tries<2000; tries++){
      kota=rng.pick(KOTA); tempat=rng.pick(TEMPAT); key=kota+"|"+tempat; if(!usedPlace.has(key)){usedPlace.add(key);break}
    }
    meta[lv]={detektif:det, kota, tempat};
  }
  return meta;
})();

/* ================== Generator Level ================== */
function genLevel(n, hard=false){
  const seed = 123456 + n*97 + (hard?777:0);
  const rng=new PRNG(seed);
  const m=metaLevels[n];
  const jenis=rng.pick(JENIS), waktu=rng.pick(JAM);
  const [partner,keahlian]=rng.pick(MITRA);
  const clueColor=rng.pick(WARNA), clueItem=rng.pick(BARANG), clueHand=rng.pick(TANGAN);
  const count=hard?5:3;
  const suspects=[], used=new Set();

  for(let i=0;i<count;i++){
    let name; do{name=rng.pick(NAMA)}while(used.has(name)); used.add(name);
    suspects.push({
      id:i, name, emoji:rng.pick(EMOJI), color:rng.pick(WARNA), item:rng.pick(BARANG), hand:rng.pick(TANGAN),
      alibi:["pesan kopi","menunggu ojek","perbaiki ponsel","latihan vokal","mencari toilet","telpon ibu","vlog","antar paket","cari parkir","bantu satpam"][Math.floor(rng.next()*10)]
    });
  }
  const culpritIndex=Math.floor(rng.next()*suspects.length);
  suspects[culpritIndex].color=clueColor; suspects[culpritIndex].item=clueItem; suspects[culpritIndex].hand=clueHand;
  for(let i=0;i<suspects.length;i++){
    if(i===culpritIndex) continue;
    if(suspects[i].color===clueColor && suspects[i].item===clueItem && suspects[i].hand===clueHand){
      suspects[i].item = BARANG[(BARANG.indexOf(suspects[i].item)+1)%BARANG.length];
    }
  }

  const story =
`Kasus ${jenis} terjadi di ${m.tempat} ${m.kota} pada ${waktu}.
Kamu, Detektif ${m.detektif}, ditemani ${partner} (ahli ${keahlian}).
CCTV melihat sosok dengan warna ${clueColor} membawa ${clueItem}.
Saksi menyebut pelaku dominan tangan ${clueHand}.`;

  const baseHints = [
    `Pelaku berhubungan dengan warna <b>${clueColor}</b>.`,
    `Ditemukan ${clueItem} di dekat pintu darurat.`,
    `Polanya konsisten dengan orang bertangan <b>${clueHand}</b>.`
  ];
  const hints = hard ? baseHints.slice(0, Math.random()<0.5?1:2) : baseHints;

  return {n, story, tmpt:m.tempat, kota:m.kota, waktu, jenis, partner,
          suspects, culpritIndex, hints, clueColor, clueItem, clueHand,
          detektif:m.detektif};
}

/* ================== UI helpers ================== */
function setProgress(){
  $("#levelBadge").textContent=`Level ${state.level} / ${TOTAL}`;
  $("#scoreBadge").textContent=`Skor ${state.score}`;
  $("#modeBadge").textContent=`Mode: ${state.mode==='hard'?'Hard':'Normal'}`;
  $("#prog").style.width = `${(state.unlocked-1)/TOTAL*100}%`;
  $("#goto").value = state.level;
  $("#nick").value = state.nick||"";
  $("#avatarImg").src = state.avatar || dummyAvatars()[0].url;
}
function toast(msg,bad=false){const el=$("#result"); el.innerHTML=msg; el.classList.toggle("hidden",false); el.className=`toast small ${bad?"bad":"ok"}`}
function setLight(){document.documentElement.dataset.theme="light";document.documentElement.style.cssText=`--bg:#f5f7fb;--card:#ffffff;--muted:#55607a;--text:#0f172a;--accent:#0077ff;--ok:#16a34a;--bad:#e11d48;--ring:#e6ecff`;document.body.style.background="linear-gradient(120deg,#eaf2ff 0%,#f6f9ff 100%)"}
function setDark(){document.documentElement.dataset.theme="dark";document.documentElement.style.cssText=`--bg:#0b1220;--card:#101a2b;--muted:#98a2b3;--text:#e6edf3;--accent:#73d7ff;--ok:#22c55e;--bad:#ff6b6b;--ring:#2b3a55`;document.body.style.background="linear-gradient(120deg,#0b1220 0%,#111a2c 100%)"}

/* ================== Render ================== */
function render(level){
  const hard=state.mode==='hard';
  const L=genLevel(level, hard);
  $("#story").innerHTML=L.story;
  $("#badgeLok").textContent=`Lokasi: ${L.tmpt}, ${L.kota}`;
  $("#badgeWaktu").textContent=`Waktu: ${L.waktu}`;
  $("#badgeJenis").textContent=`Kasus: ${L.jenis}`;
  $("#badgePartner").textContent=`Partner: ${L.partner}`;
  $("#detBadge").textContent=`Detektif: ${L.detektif}`;
  $("#lokBadge").textContent=`Lokasi: ${L.tmpt}, ${L.kota}`;

  const wrap=$("#suspects"); wrap.innerHTML="";
  L.suspects.forEach(s=>{
    const el=document.createElement("div");
    el.className="sus";
    el.innerHTML=`
      <header><div class="ava">${s.emoji}</div>
        <div><div style="font-weight:700">${s.name}</div>
        <div class="muted small">alibi: ${s.alibi}</div></div></header>
      <div class="body"><div class="meta small">
        <span class="badge">üé® ${s.color}</span><span class="badge">üéí ${s.item}</span><span class="badge">‚úã tangan ${s.hand}</span>
      </div></div>
      <div class="foot"><label class="small"><input type="radio" name="pick" value="${s.id}"> Pilih ${s.name}</label><span class="muted small">ID #${s.id+1}</span></div>`;
    wrap.appendChild(el);
  });

  $("#result").classList.add("hidden"); $("#btnNext").classList.add("hidden"); $("#btnKunci").disabled=false;
  render.current=L; setProgress();
}

/* ================== Events ================== */
$("#btnKunci").onclick=()=>{
  const L=render.current, hard=state.mode==='hard';
  const pick=[...$$('input[name="pick"]')].find(x=>x.checked); if(!pick){toast("Pilih tersangka dulu.",true);return}
  const ok=(+pick.value)===L.culpritIndex;
  if(ok){state.score+= hard?12:10; state.unlocked=Math.max(state.unlocked,state.level+1); toast(`Benar! Pelaku: ${L.suspects[L.culpritIndex].name}.`,false); $("#btnNext").classList.remove("hidden")}
  else{state.score=Math.max(0,state.score-(hard?5:3)); toast(`Salah. Petunjuk mengarah pada <b>${L.suspects[L.culpritIndex].name}</b> (üé® ${L.clueColor}, üéí ${L.clueItem}, ‚úã ${L.clueHand}).`,true)}
  $("#btnKunci").disabled=true; store.set(state); setProgress();
};
$("#btnHint").onclick=()=>{const L=render.current, hard=state.mode==='hard'; const key=`hint${L.n}${hard?'H':''}`; const used=(state[key]||0)+1; state[key]=used; state.score=Math.max(0,state.score-(hard?2:1)); const msg=L.hints[(used-1)%L.hints.length]||"Tidak ada petunjuk lagi."; toast(`Petunjuk: ${msg}`,false); store.set(state); setProgress()};
$("#btnLewati").onclick=()=>{state.unlocked=Math.max(state.unlocked,state.level+1); state.level=Math.min(100,state.level+1); store.set(state); render(state.level)};
$("#btnNext").onclick=()=>{state.level=Math.min(100,state.level+1); state.unlocked=Math.max(state.unlocked,state.level); store.set(state); render(state.level)};
$("#btnGoto").onclick=()=>{const v=+$("#goto").value||1; if(v>state.unlocked){toast("Level itu belum terbuka.",true);return} state.level=Math.min(Math.max(1,v),100); store.set(state); render(state.level)};
$("#btnReset").onclick=()=>{if(!confirm("Reset progres & skor?"))return; state={level:1,score:0,unlocked:1,mode:state.mode,nick:state.nick,theme:state.theme,avatar:state.avatar}; store.set(state); render(1)};

/* Tema toggle */
$("#btnTema").onclick=()=>{state.theme=(state.theme==="light"?"dark":"light"); store.set(state); applyTheme()};
function applyTheme(){state.theme==="light"?setLight():setDark(); $("#btnTema").textContent="Tema: "+(state.theme==="light"?"Terang":"Gelap")}
applyTheme();

/* Mode */
$("#btnMode").onclick=()=>{state.mode=state.mode==='hard'?'normal':'hard'; store.set(state); setProgress(); render(state.level)};
$("#btnSaveNick").onclick=()=>{state.nick=($("#nick").value||"").trim().slice(0,20)||"Anon"; store.set(state); toast("Nama disimpan.",false)};

/* Ekspor / Impor Progres */
$("#btnExport").onclick=()=>{
  const data=JSON.stringify({v:1,state},null,2);
  const blob=new Blob([data],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`detektif_progress_${Date.now()}.json`;
  document.body.appendChild(a); a.click(); a.remove();
};
$("#fileImport").onchange=async e=>{
  const file=e.target.files[0]; if(!file) return;
  try{
    const txt=await file.text(); const obj=JSON.parse(txt);
    if(!obj || !obj.state) throw new Error("format tidak valid");
    const s=obj.state;
    state.level=Math.min(Math.max(1, +s.level||1), TOTAL);
    state.score=Math.max(0, +s.score||0);
    state.unlocked=Math.min(TOTAL, Math.max(1, +s.unlocked||1));
    state.mode=(s.mode==="hard"?"hard":"normal");
    state.nick=(s.nick||"").toString().slice(0,20);
    state.theme=(s.theme==="light"?"light":"dark");
    state.avatar=(s.avatar||"").toString();
    store.set(state); applyTheme(); setProgress(); render(state.level);
    toast("Progres diimpor.",false);
  }catch(err){ toast("Gagal impor: "+err,true) }
};

/* ====== AVATAR PICKER: ambil dari GitHub static/avatars/ ====== */
function dummyAvatars(){
  const svgs=[
    {name:"Cat.svg",svg:`<svg xmlns='http://www.w3.org/2000/svg' width='96' height='96'><circle cx='48' cy='48' r='44' fill='#f9c74f'/><circle cx='34' cy='38' r='7'/><circle cx='62' cy='38' r='7'/><path d='M30 60 Q48 72 66 60' stroke='#000' stroke-width='5' fill='none'/></svg>`},
    {name:"Dog.svg",svg:`<svg xmlns='http://www.w3.org/2000/svg' width='96' height='96'><rect x='6' y='6' width='84' height='84' rx='16' fill='#f9844a'/><circle cx='36' cy='44' r='8'/><circle cx='60' cy='44' r='8'/><circle cx='48' cy='64' r='10'/></svg>`},
    {name:"Bear.svg",svg:`<svg xmlns='http://www.w3.org/2000/svg' width='96' height='96'><circle cx='48' cy='48' r='44' fill='#8d6e63'/><circle cx='30' cy='28' r='9' fill='#5d4037'/><circle cx='66' cy='28' r='9' fill='#5d4037'/><circle cx='38' cy='48' r='7'/><circle cx='58' cy='48' r='7'/></svg>`},
    {name:"Alien.svg",svg:`<svg xmlns='http://www.w3.org/2000/svg' width='96' height='96'><ellipse cx='48' cy='56' rx='40' ry='36' fill='#90be6d'/><ellipse cx='36' cy='44' rx='12' ry='16'/><ellipse cx='60' cy='44' rx='12' ry='16'/></svg>`},
    {name:"Robot.svg",svg:`<svg xmlns='http://www.w3.org/2000/svg' width='96' height='96'><rect x='14' y='14' width='68' height='68' rx='12' fill='#577590'/><circle cx='36' cy='46' r='8' fill='#f1faee'/><circle cx='60' cy='46' r='8' fill='#f1faee'/><rect x='30' y='64' width='36' height='8' fill='#f1faee'/></svg>`}
  ];
  return svgs.map(x=>{
    const url=URL.createObjectURL(new Blob([x.svg],{type:"image/svg+xml"}));
    return {name:x.name,url};
  });
}

async function fetchAvatarList(){
  const api = `https://api.github.com/repos/${AVATAR_CFG.OWNER}/${AVATAR_CFG.REPO}/contents/${AVATAR_CFG.PATH}?ref=${AVATAR_CFG.BRANCH}`;
  try{
    const res=await fetch(api);
    if(!res.ok) throw new Error(res.status+" "+res.statusText);
    const data=await res.json();
    const files=(data||[]).filter(f=>f.type==="file" && /\.(png|jpg|jpeg|webp|svg|gif|avif)$/i.test(f.name));
    if(!files.length) return dummyAvatars();
    return files.map(f=>({name:f.name,url:f.download_url}));
  }catch(e){
    return dummyAvatars();
  }
}

function openAvatarModal(list){
  const modal=$("#avatarModal"), grid=$("#avatarGrid");
  grid.innerHTML = list.map(a=>(
    `<div class="item" data-url="${a.url}">
       <img loading="lazy" src="${a.url}" alt="${esc(a.name)}">
       <div class="cap">${esc(a.name)}</div>
     </div>`
  )).join("");
  grid.querySelectorAll(".item").forEach(it=>{
    it.onclick=()=>{
      state.avatar = it.dataset.url;
      store.set(state);
      $("#avatarImg").src = state.avatar;
      modal.style.display="none";
      toast("Avatar diganti.",false);
    };
  });
  modal.style.display="flex";
}

$("#avatarBtn").onclick=async()=>{ openAvatarModal(await fetchAvatarList()) };
$("#avatarClose").onclick=()=>{ $("#avatarModal").style.display="none" };
$("#avatarModal").addEventListener("click",(e)=>{ if(e.target.id==="avatarModal") e.currentTarget.style.display="none" });

/* ====== Papan skor ====== */
async function loadBoard(){
  const tb=$("#board tbody"); tb.innerHTML="<tr><td colspan='5' class='muted'>Memuat‚Ä¶</td></tr>";
  try{
    let rows=[];
    if(SCOREBOARD_ENDPOINT){
      const r=await fetch(SCOREBOARD_ENDPOINT,{method:"GET",headers:{"Accept":"application/json"}});
      rows=await r.json();
    }else{
      rows=localBoard().get();
    }
    rows=(rows||[]).slice(0,50);
    if(!rows.length){tb.innerHTML="<tr><td colspan='5' class='muted'>Belum ada skor.</td></tr>";return}
    tb.innerHTML=rows.map((x,i)=>`<tr><td>${i+1}</td><td>${esc(x.name)}</td><td>${x.score}</td><td>${x.mode||'normal'}</td><td>${timeago(x.ts||Date.now())}</td></tr>`).join("");
  }catch(e){
    tb.innerHTML=`<tr><td colspan='5' class='bad small'>Gagal ambil papan skor: ${esc(String(e))}</td></tr>`;
  }
}
function localBoard(){const key="detektif100-board";return{get(){try{return JSON.parse(localStorage.getItem(key)||"[]")}catch{return[]}},set(list){localStorage.setItem(key,JSON.stringify(list))}}}
async function submitScore(){
  const name=(state.nick||"").trim()||"Anon";
  const payload={name,score:state.score,mode:state.mode,avatar:state.avatar,ts:Date.now()};
  try{
    if(SCOREBOARD_ENDPOINT){
      await fetch(SCOREBOARD_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
      toast("Skor terkirim ke papan skor publik.",false);
    }else{
      const lb=localBoard(); const list=lb.get(); list.push(payload); list.sort((a,b)=>b.score-a.score); lb.set(list.slice(0,50));
      toast("Skor disimpan (lokal). Set endpoint untuk publik.",false);
    }
    loadBoard();
  }catch(e){ toast("Gagal kirim skor: "+e,true) }
}
$("#btnSubmitScore").onclick=submitScore;
$("#btnRefreshBoard").onclick=loadBoard;

/* Init */
function setProgressInit(){
  state.level=Math.min(Math.max(1,state.level||1),TOTAL);
  state.unlocked=Math.max(1,Math.min(TOTAL,state.unlocked||1));
  setProgress();
}
setProgressInit(); render(state.level); loadBoard();
</script>
</body>
</html>
